{% extends 'pharma/base2.html' %}
 {% load static %}
  {% load widget_tweaks %} 
  {%load heroicons %} 
  {% block title %} 
  Categories 
  {% endblock %} 
  {% block content%}
<div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 ml-10 gap-6" style="margin-left: 10px;">
  {% if popular_items %} {% for item in popular_items %}

  <div>
    <a href="{% url 'item' name=item.name  id=item.id %}" class="block space-y-2">
      <img
        src="{{ item.image.url }}"
        class="w-full h-[284px] object-contain"
        alt="Popular Product"
      />
      <h6 class="text-blue-900 text-lg">{{ item.name }}</h6>
      <span class="text-green-400 px-8 ml-10 text-xl font-sans"> ₦ {{ item.price }}</span>
      <br>
      {% if item.shipping == 0%}
      <span class="text-gray-500 px-8 ml-10 text-xl font-sans">Free Shipping</span>
      {% else %}
      <span class="text-gray-500 px-8 ml-10 text-xl font-sans">Shipping: ₦ {{ item.shipping }}</span>
      {% endif %}
    </a>
  </div>

  {% endfor %} {% else %}
  <h6 class="text-blue-900 text-lg w-full h-[284px]">No item found</h6>

  {% endif %}
</div>

<script>
let page = 1;
let loading = false;
let hasNext = true;

function renderProduct(item) {
  return `
    <div>
      <a href="/categories/${item.name}/${item.id}/" class="block space-y-2">
        <img src="${item.image_url}" class="w-full h-[284px] object-contain" alt="Popular Product"/>
        <h6 class="text-blue-900 text-lg">${item.name}</h6>
        <span class="text-green-400 px-8 ml-10 text-xl font-sans">₦ ${item.price}</span><br>
        ${item.shipping == 0
          ? `<span class="text-gray-500 px-8 ml-10 text-xl font-sans">Free Shipping</span>`
          : `<span class="text-gray-500 px-8 ml-10 text-xl font-sans">Shipping: ₦ ${item.shipping}</span>`
        }
      </a>
    </div>
  `;
}

async function loadMoreProducts() {
  if (loading || !hasNext) return;
  loading = true;
  page += 1;
  const res = await fetch(`/api/products/?page=${page}`);
  const data = await res.json();
  hasNext = data.has_next;
  const grid = document.querySelector('.grid');
  data.items.forEach(item => {
    grid.insertAdjacentHTML('beforeend', renderProduct(item));
  });
  loading = false;
}

window.addEventListener('scroll', () => {
  const scrollY = window.scrollY || window.pageYOffset;
  const viewportHeight = window.innerHeight;
  const fullHeight = document.body.offsetHeight;
  if (scrollY + viewportHeight >= fullHeight - 100) {
    loadMoreProducts();
  }
});
</script>
{% endblock %}
